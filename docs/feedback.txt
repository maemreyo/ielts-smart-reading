**Cập nhật ngày 29/10/2025 - Bắt đầu lại**

**Tổng quan:** Đã có những bước tiến vượt bậc. Các vấn đề về cấu trúc dữ liệu, tính năng export, chống trùng lặp và layout đã được giải quyết. Tuy nhiên, một lỗi nghiêm trọng về logic tính toán vị trí vẫn còn.

---

## Phân tích các vấn đề còn lại

**1. [LỖI NGHIÊM TRỌNG] Không xác định đúng `paragraphIndex` từ DOM Selection:**

*   **Vấn đề:** Khi người dùng kéo thả chuột để chọn văn bản ở các đoạn văn sau đoạn 1 (P2, P3,...), hệ thống vẫn xác định sai rằng lựa chọn đó thuộc về đoạn 1 (`paragraphIndex: 0`).
*   **Bằng chứng từ log:**
    *   Khi chọn text ở đoạn 2, log ghi: `🎯 Found paragraph: { paragraphIndex: 0, ... actualParagraphInDiv: 1 }`. Tìm đúng `div` nhưng sai `index`.
    *   Khi chọn text ở đoạn 3, log ghi: `⚠️ Fallback to first paragraph`. Logic thất bại hoàn toàn.
*   **Nguyên nhân gốc rễ:** Mặc dù mảng `paragraphOffsets` đã được tính toán chính xác, nhưng logic trong `handleMouseUp` (hoặc các hàm con của nó) đang không thể **ánh xạ** một cách đáng tin cậy từ một `div` (phần tử DOM) mà người dùng chọn sang `index` tương ứng của nó trong mảng `paragraphs`. Vì nó luôn trả về `paragraphIndex: 0`, các phép tính vị trí cho các đoạn sau đều sai.
*   **Khuyến nghị:** Tập trung toàn lực vào việc sửa logic tìm `paragraphIndex` từ một DOM selection. Đây là ưu tiên tuyệt đối.

**2. [LỖI LOGIC] `displayText` cho cụm từ hỗn hợp (liền kề + không liền kề) bị sai:**

*   **Vấn đề:** Khi chọn một nhóm từ liền kề và một từ ở xa (ví dụ: `[A, B, C, E]`), `displayText` được tạo ra là `"A ... B ... C ... E"` thay vì `"A B C ... E"`.
*   **Nguyên nhân:** Logic kiểm tra liền kề (`Contiguity check`) chưa đủ thông minh để nhận diện các "cụm con liền kề" bên trong một lựa chọn lớn hơn.
*   **Khuyến nghị:** Nâng cấp logic tạo `displayText` để nó có thể xác định các nhóm liền kề và chỉ chèn `...` vào giữa các nhóm đó.

**3. [TÍNH NĂNG THIẾU] Bỏ highlight (Unhighlighting):**

*   **Vấn đề:** Vẫn chưa thể xóa một highlight bằng cách nhấp vào nó.

hị từ vựng cho đơn giản, trực quan hơn (chỉ cần `displayText`).

## Kết luận & Ưu tiên

1.  **Ưu tiên #1 (Lỗi nghiêm trọng):** Sửa **Vấn đề #1** (xác định sai `paragraphIndex`). Đây là lỗi chặn (blocker) cho toàn bộ chức năng highlight bằng cách kéo thả.